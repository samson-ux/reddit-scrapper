<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Research Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f1a, #1a1a2e, #16213e);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 40px 20px; }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #a0a0a0; font-size: 1.1rem; }

        .api-banner {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .api-banner input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-family: monospace;
        }
        .api-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .api-status.connected { background: rgba(0,210,106,0.2); color: #00d26a; }
        .api-status.disconnected { background: rgba(255,71,87,0.2); color: #ff4757; }

        .steps-container { display: flex; gap: 20px; margin: 30px 0; flex-wrap: wrap; }
        .step-card {
            flex: 1;
            min-width: 300px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s;
        }
        .step-card.active { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .step-card.completed { border-color: #00d26a; background: rgba(0,210,106,0.1); }
        .step-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .step-number {
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem;
        }
        .step-card.active .step-number { background: #667eea; }
        .step-card.completed .step-number { background: #00d26a; }
        .step-title { font-size: 1.2rem; font-weight: 600; }

        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #ccc; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        input::placeholder { color: #666; }
        select option { background: #1a1a2e; color: #fff; }

        .goal-container { display: flex; gap: 10px; }
        .goal-container select { width: 200px; flex-shrink: 0; }
        .goal-container input { flex: 1; }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102,126,234,0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-success { background: linear-gradient(135deg, #00d26a, #00a854); color: #fff; }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; }

        .tags-container { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; max-height: 250px; overflow-y: auto; }
        .tag {
            background: rgba(102,126,234,0.2);
            border: 1px solid rgba(102,126,234,0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tag:hover { background: rgba(102,126,234,0.4); }
        .tag.selected { background: #667eea; border-color: #667eea; }

        .add-tag-input { display: flex; gap: 10px; margin-top: 10px; }
        .add-tag-input input { flex: 1; padding: 10px 15px; }

        .subreddit-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .subreddit-chip {
            background: rgba(0,210,106,0.2);
            border: 1px solid rgba(0,210,106,0.5);
            color: #00d26a;
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .subreddit-chip:hover { background: rgba(0,210,106,0.4); }
        .subreddit-chip.selected { background: #00d26a; color: #000; }

        .results-container { margin-top: 30px; }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
        }
        .results-stats { display: flex; gap: 30px; }
        .stat { text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 0.85rem; color: #888; }

        .filter-tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .filter-tab {
            padding: 8px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 20px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-tab:hover { background: rgba(255,255,255,0.2); }
        .filter-tab.active { background: #667eea; color: #fff; }

        .comments-grid { display: grid; gap: 15px; }
        .comment-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }
        .comment-card:hover { background: rgba(255,255,255,0.08); transform: translateX(5px); }
        .comment-post-title { font-size: 0.9rem; color: #888; margin-bottom: 8px; }
        .comment-post-title a { color: #667eea; text-decoration: none; }
        .comment-post-title a:hover { text-decoration: underline; }
        .comment-header { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 10px; }
        .comment-body { color: #ddd; font-size: 1rem; line-height: 1.7; flex: 1; }
        .comment-stats { color: #888; font-size: 0.9rem; flex-shrink: 0; }
        .comment-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .comment-tag { background: rgba(240,147,251,0.2); color: #f093fb; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; }
        .comment-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
            color: #666;
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .spinner {
            width: 60px; height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 1.1rem; color: #ccc; }
        .loading-subtext { margin-top: 8px; font-size: 0.9rem; color: #888; }
        .loading-log {
            margin-top: 20px;
            max-width: 500px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.85rem;
            color: #888;
        }
        .loading-log div { margin: 5px 0; }
        .loading-log .success { color: #00d26a; }
        .loading-log .error { color: #ff4757; }

        .ai-thinking {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(102,126,234,0.1);
            border-radius: 10px;
            margin: 10px 0;
        }
        .ai-dots { display: flex; gap: 4px; }
        .ai-dot {
            width: 8px; height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .ai-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .error-message {
            background: rgba(255,71,87,0.2);
            border: 1px solid rgba(255,71,87,0.5);
            color: #ff4757;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .steps-container { flex-direction: column; }
            .goal-container { flex-direction: column; }
            .goal-container select { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† Reddit Research Tool</h1>
            <p class="subtitle">AI-powered niche research - Get specific tags & scrape comments</p>
        </header>

        <div class="api-banner">
            <span>üîë Claude API Key (optional):</span>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-api... for smart tags" />
            <button class="btn btn-small btn-secondary" onclick="toggleApiKey()">üëÅ</button>
            <span class="api-status disconnected" id="apiStatus">Not set</span>
            <button class="btn btn-small btn-primary" onclick="testApiKey()">Test</button>
        </div>

        <div class="steps-container">
            <div class="step-card active" id="step1Card">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Enter Topic</div>
                </div>
                <div class="input-group">
                    <label>What do you want to research?</label>
                    <input type="text" id="topicInput" placeholder="e.g., UFC, crypto, skincare..." />
                </div>
                <div class="input-group">
                    <label>Goal (pick OR type your own)</label>
                    <div class="goal-container">
                        <select id="goalSelect" onchange="handleGoalSelect()">
                            <option value="">-- Quick picks --</option>
                            <option value="Find business opportunities">Business ideas</option>
                            <option value="Discover trends">Trends</option>
                            <option value="Find problems/complaints">Problems</option>
                            <option value="Product research">Products</option>
                            <option value="Understand debates">Opinions</option>
                        </select>
                        <input type="text" id="goalInput" placeholder="Or type your goal..." />
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateTags()">ü§ñ Generate Tags</button>
                <div id="step1Error" class="error-message hidden"></div>
            </div>

            <div class="step-card" id="step2Card">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Review Tags</div>
                </div>
                <div id="aiThinking" class="ai-thinking hidden">
                    <div class="ai-dots"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div></div>
                    <span>Generating niche tags...</span>
                </div>
                <div id="tagsSection" class="hidden">
                    <label>Tags (click to toggle)</label>
                    <div class="tags-container" id="tagsContainer"></div>
                    <div class="add-tag-input">
                        <input type="text" id="newTagInput" placeholder="Add tag..." />
                        <button class="btn btn-secondary" onclick="addCustomTag()">+</button>
                    </div>
                    <label style="margin-top:15px;">Subreddits</label>
                    <div class="subreddit-chips" id="subredditsContainer"></div>
                    <div class="add-tag-input">
                        <input type="text" id="newSubInput" placeholder="Add subreddit..." />
                        <button class="btn btn-secondary" onclick="addCustomSubreddit()">+</button>
                    </div>
                    <div style="margin-top:20px;">
                        <button class="btn btn-success" onclick="startScraping()">üöÄ Scrape Comments</button>
                    </div>
                </div>
            </div>

            <div class="step-card" id="step3Card">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Results</div>
                </div>
                <div id="resultsPreview"><p style="color:#666;">Comments will appear here</p></div>
            </div>
        </div>

        <div id="fullResults" class="results-container hidden">
            <div class="results-header">
                <div class="results-stats">
                    <div class="stat"><div class="stat-value" id="totalComments">0</div><div class="stat-label">Comments</div></div>
                    <div class="stat"><div class="stat-value" id="totalPosts">0</div><div class="stat-label">Posts</div></div>
                    <div class="stat"><div class="stat-value" id="totalUpvotes">0</div><div class="stat-label">Upvotes</div></div>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-secondary" onclick="exportCSV()">üì• CSV</button>
                    <button class="btn btn-secondary" onclick="exportJSON()">üì• JSON</button>
                </div>
            </div>
            <div class="filter-tabs" id="categoryFilters"></div>
            <div class="comments-grid" id="commentsGrid"></div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
        <div class="loading-subtext" id="loadingSubtext">Please wait</div>
        <div class="loading-log" id="loadingLog"></div>
    </div>

    <script>
        let generatedTags = [], selectedTags = [], suggestedSubreddits = [], selectedSubreddits = [];
        let allComments = [], categorizedComments = {}, currentTopic = '', postsSearched = 0;

        function handleGoalSelect() {
            const s = document.getElementById('goalSelect');
            if (s.value) document.getElementById('goalInput').value = s.value;
        }

        function toggleApiKey() {
            const i = document.getElementById('apiKeyInput');
            i.type = i.type === 'password' ? 'text' : 'password';
        }

        async function testApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const status = document.getElementById('apiStatus');
            if (!key) { status.textContent = 'No key'; status.className = 'api-status disconnected'; return; }
            status.textContent = 'Testing...';
            try {
                const r = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 10, messages: [{ role: 'user', content: 'Hi' }] })
                });
                status.textContent = r.ok ? '‚úì Connected' : 'Invalid';
                status.className = r.ok ? 'api-status connected' : 'api-status disconnected';
            } catch (e) { status.textContent = 'Error'; status.className = 'api-status disconnected'; }
        }

        async function generateTags() {
            const topic = document.getElementById('topicInput').value.trim();
            const goal = document.getElementById('goalInput').value.trim() || 'general';
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!topic) { showError('step1Error', 'Enter a topic'); return; }
            currentTopic = topic;
            hideError('step1Error');
            document.getElementById('step1Card').classList.remove('active');
            document.getElementById('step1Card').classList.add('completed');
            document.getElementById('step2Card').classList.add('active');
            document.getElementById('aiThinking').classList.remove('hidden');
            document.getElementById('tagsSection').classList.add('hidden');

            let result;
            try {
                result = key ? await generateTagsWithClaude(topic, goal, key) : generateFallbackTags(topic);
            } catch (e) { result = generateFallbackTags(topic); }

            generatedTags = result.tags;
            selectedTags = [...generatedTags];
            suggestedSubreddits = result.subreddits;
            selectedSubreddits = [...suggestedSubreddits].slice(0, 5);
            renderTags();
            renderSubreddits();
            document.getElementById('aiThinking').classList.add('hidden');
            document.getElementById('tagsSection').classList.remove('hidden');
        }

        async function generateTagsWithClaude(topic, goal, key) {
            const prompt = `Research topic: "${topic}". Goal: "${goal}".
Generate SPECIFIC niche tags including: current key figures (spelled correctly), recent events, specific products/brands, community slang, controversies, common complaints.
Also suggest best subreddits.
RESPOND ONLY JSON: {"tags":["tag1","tag2"...],"subreddits":["sub1","sub2"...]}
15-25 specific tags, 5-8 subreddits. NO generic tags.`;
            const r = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1000, messages: [{ role: 'user', content: prompt }] })
            });
            if (!r.ok) throw new Error('API failed');
            const d = await r.json();
            const m = d.content[0].text.match(/\{[\s\S]*\}/);
            return m ? JSON.parse(m[0]) : generateFallbackTags(topic);
        }

        function generateFallbackTags(topic) {
            const t = topic.toLowerCase();
            const db = {
                'ufc': { tags: ['Ilia Topuria', 'Jon Jones', 'Islam Makhachev', 'Alex Pereira', 'Sean OMalley', 'Dana White', 'Conor McGregor', 'UFC 310', 'UFC 311', 'title shot', 'knockout', 'submission', 'GOAT debate', 'weight cut', 'PED', 'judging controversy'], subs: ['ufc', 'MMA', 'mmafights'] },
                'mma': { tags: ['UFC', 'Bellator', 'ONE Championship', 'grappling', 'striking', 'Jon Jones', 'Islam Makhachev'], subs: ['MMA', 'ufc', 'martialarts'] },
                'crypto': { tags: ['Bitcoin', 'Ethereum', 'Solana', 'XRP', 'altseason', 'bull run', 'DeFi', 'memecoin', 'Binance', 'ETF'], subs: ['cryptocurrency', 'Bitcoin', 'ethereum', 'CryptoMarkets'] },
                'fitness': { tags: ['progressive overload', 'bulk', 'cut', 'PPL', 'creatine', 'protein', 'form check', 'plateau', 'natty'], subs: ['fitness', 'bodybuilding', 'gainit', 'loseit'] },
                'skincare': { tags: ['retinol', 'tretinoin', 'CeraVe', 'The Ordinary', 'sunscreen', 'acne', 'hyperpigmentation'], subs: ['SkincareAddiction', 'AsianBeauty', 'tretinoin'] },
                'dating': { tags: ['Hinge', 'Tinder', 'Bumble', 'ghosting', 'red flags', 'first date', 'texting'], subs: ['dating', 'dating_advice', 'Tinder', 'hingeapp'] }
            };
            let tags = [topic], subs = [];
            for (const [k, v] of Object.entries(db)) {
                if (t.includes(k) || k.includes(t)) { tags.push(...v.tags); subs.push(...v.subs); }
            }
            if (subs.length === 0) subs = ['AskReddit', 'NoStupidQuestions'];
            return { tags: [...new Set(tags)].slice(0, 20), subreddits: [...new Set(subs)].slice(0, 6) };
        }

        function renderTags() {
            document.getElementById('tagsContainer').innerHTML = generatedTags.map(tag =>
                `<div class="tag ${selectedTags.includes(tag) ? 'selected' : ''}" onclick="toggleTag(this,'${esc(tag)}')">${escH(tag)}</div>`
            ).join('');
        }

        function toggleTag(el, tag) {
            if (selectedTags.includes(tag)) { selectedTags = selectedTags.filter(t => t !== tag); el.classList.remove('selected'); }
            else { selectedTags.push(tag); el.classList.add('selected'); }
        }

        function addCustomTag() {
            const i = document.getElementById('newTagInput'), tag = i.value.trim();
            if (tag && !generatedTags.includes(tag)) { generatedTags.push(tag); selectedTags.push(tag); renderTags(); i.value = ''; }
        }

        function renderSubreddits() {
            document.getElementById('subredditsContainer').innerHTML = suggestedSubreddits.map(sub =>
                `<div class="subreddit-chip ${selectedSubreddits.includes(sub) ? 'selected' : ''}" onclick="toggleSub(this,'${esc(sub)}')">r/${escH(sub)}</div>`
            ).join('');
        }

        function toggleSub(el, sub) {
            if (selectedSubreddits.includes(sub)) { selectedSubreddits = selectedSubreddits.filter(s => s !== sub); el.classList.remove('selected'); }
            else { selectedSubreddits.push(sub); el.classList.add('selected'); }
        }

        function addCustomSubreddit() {
            const i = document.getElementById('newSubInput'), sub = i.value.trim().replace('r/', '');
            if (sub && !suggestedSubreddits.includes(sub)) { suggestedSubreddits.push(sub); selectedSubreddits.push(sub); renderSubreddits(); i.value = ''; }
        }

        async function startScraping() {
            if (!selectedTags.length || !selectedSubreddits.length) { alert('Select tags and subreddits'); return; }
            document.getElementById('step2Card').classList.remove('active');
            document.getElementById('step2Card').classList.add('completed');
            document.getElementById('step3Card').classList.add('active');
            showLoading('Starting...', 'Searching Reddit');
            clearLog();
            try {
                allComments = await scrapeComments();
                categorizedComments = categorize(allComments);
                hideLoading();
                renderResults();
            } catch (e) { hideLoading(); alert('Error: ' + e.message); }
        }

        async function scrapeComments() {
            const comments = [], seen = new Set();
            postsSearched = 0;
            for (const sub of selectedSubreddits) {
                addLog(`Searching r/${sub}...`);
                for (const tag of selectedTags.slice(0, 8)) {
                    updateLoading(`r/${sub}`, `"${tag}"`);
                    try {
                        const url = `https://www.reddit.com/r/${sub}/search.json?q=${encodeURIComponent(tag)}&restrict_sr=1&limit=15&sort=relevance&t=year`;
                        const res = await fetch(url, { headers: { 'User-Agent': 'ResearchTool/1.0' } });
                        if (!res.ok) { if (res.status === 429) { addLog('Rate limited...', 'error'); await sleep(5000); } continue; }
                        const data = await res.json();
                        const posts = data.data?.children || [];
                        for (const post of posts.slice(0, 5)) {
                            const p = post.data;
                            postsSearched++;
                            if (p.num_comments < 3) continue;
                            try {
                                const cUrl = `https://www.reddit.com${p.permalink}.json?limit=25&sort=top`;
                                const cRes = await fetch(cUrl, { headers: { 'User-Agent': 'ResearchTool/1.0' } });
                                if (!cRes.ok) continue;
                                const cData = await cRes.json();
                                for (const c of (cData[1]?.data?.children || [])) {
                                    if (c.kind !== 't1') continue;
                                    const cd = c.data;
                                    if (seen.has(cd.id) || !cd.body || cd.body === '[deleted]' || cd.body.length < 30) continue;
                                    seen.add(cd.id);
                                    comments.push({
                                        id: cd.id, body: cd.body.substring(0, 2000), score: cd.score || 0,
                                        author: cd.author, subreddit: sub, postTitle: p.title,
                                        postUrl: `https://reddit.com${p.permalink}`,
                                        created: new Date(cd.created_utc * 1000).toISOString().split('T')[0],
                                        matchedTag: tag
                                    });
                                }
                                await sleep(200);
                            } catch (e) {}
                        }
                        await sleep(400);
                    } catch (e) { addLog(`Error: ${tag}`, 'error'); }
                }
                addLog(`r/${sub} done: ${comments.length} total`, 'success');
            }
            addLog(`Complete! ${comments.length} comments`, 'success');
            comments.sort((a, b) => b.score - a.score);
            return comments;
        }

        function categorize(comments) {
            const cats = {};
            for (const c of comments) {
                const text = c.body.toLowerCase(), matched = [];
                for (const tag of selectedTags) if (text.includes(tag.toLowerCase())) matched.push(tag);
                if (c.matchedTag && !matched.includes(c.matchedTag)) matched.push(c.matchedTag);
                c.categories = matched.length ? matched : ['General'];
                for (const cat of c.categories) { if (!cats[cat]) cats[cat] = []; cats[cat].push(c); }
            }
            return cats;
        }

        function renderResults() {
            document.getElementById('fullResults').classList.remove('hidden');
            document.getElementById('resultsPreview').innerHTML = `<p style="color:#00d26a;">‚úì ${allComments.length} comments</p>`;
            document.getElementById('totalComments').textContent = allComments.length;
            document.getElementById('totalPosts').textContent = postsSearched;
            const up = allComments.reduce((s, c) => s + c.score, 0);
            document.getElementById('totalUpvotes').textContent = up > 1000 ? Math.round(up / 1000) + 'K' : up;
            const sorted = Object.entries(categorizedComments).sort((a, b) => b[1].length - a[1].length).slice(0, 8);
            document.getElementById('categoryFilters').innerHTML = `<button class="filter-tab active" onclick="filterC('all',this)">All (${allComments.length})</button>` +
                sorted.map(([cat, items]) => `<button class="filter-tab" onclick="filterC('${esc(cat)}',this)">${escH(cat)} (${items.length})</button>`).join('');
            renderComments(allComments);
        }

        function filterC(cat, btn) {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderComments(cat === 'all' ? allComments : (categorizedComments[cat] || []));
        }

        function renderComments(comments) {
            const g = document.getElementById('commentsGrid');
            if (!comments.length) { g.innerHTML = '<p style="color:#888;text-align:center;padding:40px;">No comments</p>'; return; }
            g.innerHTML = comments.slice(0, 100).map(c => `
                <div class="comment-card">
                    <div class="comment-post-title">From: <a href="${c.postUrl}" target="_blank">${escH(c.postTitle.substring(0, 70))}...</a></div>
                    <div class="comment-header">
                        <div class="comment-body">${escH(c.body.substring(0, 400))}${c.body.length > 400 ? '...' : ''}</div>
                        <div class="comment-stats">üëç ${c.score}</div>
                    </div>
                    <div class="comment-tags">${c.categories.slice(0, 3).map(cat => `<span class="comment-tag">${escH(cat)}</span>`).join('')}</div>
                    <div class="comment-meta"><span>r/${c.subreddit} ‚Ä¢ u/${c.author}</span><span>${c.created}</span></div>
                </div>
            `).join('');
        }

        function exportCSV() {
            if (!allComments.length) return;
            const h = ['Comment', 'Score', 'Author', 'Subreddit', 'Post', 'Categories', 'Date', 'URL'];
            const rows = allComments.map(c => [`"${c.body.replace(/"/g, '""').replace(/\n/g, ' ')}"`, c.score, c.author, c.subreddit, `"${c.postTitle.replace(/"/g, '""')}"`, `"${c.categories.join(', ')}"`, c.created, c.postUrl]);
            download([h.join(','), ...rows.map(r => r.join(','))].join('\n'), `reddit_${currentTopic}.csv`, 'text/csv');
        }

        function exportJSON() {
            if (!allComments.length) return;
            download(JSON.stringify({ topic: currentTopic, tags: selectedTags, subreddits: selectedSubreddits, comments: allComments }, null, 2), `reddit_${currentTopic}.json`, 'application/json');
        }

        function download(content, name, type) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type }));
            a.download = name;
            a.click();
        }

        function showLoading(t, s) { document.getElementById('loadingText').textContent = t; document.getElementById('loadingSubtext').textContent = s; document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function updateLoading(t, s) { document.getElementById('loadingText').textContent = t; document.getElementById('loadingSubtext').textContent = s; }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function clearLog() { document.getElementById('loadingLog').innerHTML = ''; }
        function addLog(m, type = '') { const d = document.createElement('div'); d.className = type; d.textContent = '> ' + m; const l = document.getElementById('loadingLog'); l.appendChild(d); l.scrollTop = l.scrollHeight; }
        function showError(id, m) { const e = document.getElementById(id); e.textContent = m; e.classList.remove('hidden'); }
        function hideError(id) { document.getElementById(id).classList.add('hidden'); }
        function escH(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function esc(t) { return t.replace(/'/g, "\\'").replace(/"/g, '\\"'); }
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        document.getElementById('topicInput').addEventListener('keypress', e => { if (e.key === 'Enter') generateTags(); });
        document.getElementById('newTagInput').addEventListener('keypress', e => { if (e.key === 'Enter') addCustomTag(); });
        document.getElementById('newSubInput').addEventListener('keypress', e => { if (e.key === 'Enter') addCustomSubreddit(); });
    </script>
</body>
</html>
